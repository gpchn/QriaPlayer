<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Paio - Player All In One</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§æ’­æ”¾åˆ—è¡¨ -->
        <div class="playlist-container">
            <h2>Playlist</h2>
            <ul id="playlist"></ul>
        </div>

        <!-- å³ä¾§æ’­æ”¾æ§åˆ¶ -->
        <div class="player-container">
            <!-- å°é¢æ˜¾ç¤º -->
            <div class="cover-container">
                <img id="coverImage" src="/static/default_cover.jpg" alt="Album Cover">
            </div>

            <!-- æ­Œè¯æ˜¾ç¤º -->
            <div class="lyrics-container" id="lyricsBox"></div>

            <!-- æ­Œæ›²ä¿¡æ¯ -->
            <div class="song-info">
                <h2 id="songTitle">- è¯·é€‰å–ä¸€é¦–æ­Œæ’­æ”¾ -</h2>
                <p id="songArtist"></p>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="progress-container">
                <input type="range" id="progressBar" value="0" class="progress">
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="controls">
                <button onclick="togglePlay()" id="playBtn">â–¶</button>
                <button onclick="toggleMute()" id="muteBtn">ğŸ”Š</button>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1">
            </div>
        </div>
    </div>

    <script>
        const audio = new Audio();
        let currentSong = null;
        let lyricsData = [];

        // åˆå§‹åŒ–åŠ è½½æ’­æ”¾åˆ—è¡¨
        window.addEventListener('load', async () => {
            await loadPlaylist();
        });

        // åŠ è½½æ’­æ”¾åˆ—è¡¨
        async function loadPlaylist() {
            const res = await fetch('/api/music');
            const { music_list } = await res.json();
            
            const playlist = document.getElementById('playlist');
            playlist.innerHTML = music_list.map(song => `
                <li onclick="loadSong('${song}')">
                    ${song.replace('.mp3', '')}
                </li>
            `).join('');
        }

        // åŠ è½½æ­Œæ›²
        async function loadSong(filename) {
            currentSong = filename;
            
            // è·å–æ­Œæ›²å…ƒæ•°æ®
            const res = await fetch(`/api/music/${filename}`);
            const { title, artist, duration, cover_url } = await res.json();
            
            // æ›´æ–°ç•Œé¢
            document.getElementById('songTitle').textContent = title;
            document.getElementById('songArtist').textContent = artist;
            document.getElementById('coverImage').src = cover_url;

            // åŠ è½½éŸ³é¢‘
            audio.src = `/musics/${filename}`;
            audio.play();

            // åŠ è½½æ­Œè¯
            const lrcRes = await fetch(`/api/lyrics/${filename.replace('.mp3', '.lrc')}`);
            const { lyrics } = await lrcRes.json();
            lyricsData = lyrics;
        }

        // æ’­æ”¾/æš‚åœæ§åˆ¶
        function togglePlay() {
            audio.paused ? audio.play() : audio.pause();
        }

        // é™éŸ³æ§åˆ¶
        function toggleMute() {
            audio.muted = !audio.muted;
        }

        // è¿›åº¦æ¡æ›´æ–°
        audio.addEventListener('timeupdate', () => {
            const progress = (audio.currentTime / audio.duration) * 100;
            document.getElementById('progressBar').value = progress;
            
            // æ—¶é—´æ˜¾ç¤º
            document.getElementById('currentTime').textContent = 
                formatTime(audio.currentTime);
            document.getElementById('duration').textContent = 
                formatTime(audio.duration);
        });

        // éŸ³é‡æ§åˆ¶
        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            audio.volume = e.target.value;
        });

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>